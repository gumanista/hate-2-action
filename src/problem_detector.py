# problem_detector.py

import os
import json
import time
from typing import List, Dict

from langchain.chat_models import ChatOpenAI
from langchain.schema import SystemMessage, HumanMessage, AIMessage

from src.database import Database

MODEL_NAME = "gpt-4.1-nano-2025-04-14"
MAX_RETRIES = 2
REQUEST_DELAY_SECONDS = 1

# -----------------------------------------------------------------------------
# Few‐shot examples for problem detection
# -----------------------------------------------------------------------------
EXAMPLES = [
  {
    "post": "Він і пуйла називає харошим парнєм, лиш той \"хароший парєнь\" по вуха в крові українській",
    "json": {
      "problems": [
        {
          "name": "Толерантність до воєнного злочинця",
          "context": "Перетворення воєнного злочинця на «харошого парня» демонструє небезпечну толерантність до злочинів та насильства, що руйнує загальнолюдські моральні принципи й створює прецедент нормалізації безкарності. Така позиція вказує на глибоку моральну аморальність і безвідповідальність мовця, який нехтує інформаційною безпекою суспільства та знижує рівень критичного мислення громадян. Прийняття образу воєнного злочинця як «харошого парня» сприяє десенсибілізації аудиторії до масштабних страждань українців і знецінює їхню історичну пам’ять, перетворюючи трагедію на зручну медіа-маніпуляцію та культивуючи спотворене сприйняття воєнних злочинів.",
          "solution": "Запровадити системні заходи з медіаграмотності та суспільної свідомості: розробити курси з критичного мислення в школах і вишах, що включають вивчення морально-етичних норм і міжнародного гуманітарного права; організувати публічні дискусії та круглі столи за участю експертів із прав людини, військових аналітиків і журналістів для обговорення наслідків воєнних злочинів; створити законодавчі ініціативи, що карають за виправдання чи виправдовування воєнних злочинців у медіапросторі; підтримувати громадські проєкти меморіалізації жертв із залученням волонтерських груп і культурних інституцій; впровадити стандарти роботи ЗМІ, які забороняють позитивні оцінки дій осіб, причетних до війни, та передбачають етичний кодекс із жорсткими санкціями за порушення принципів об’єктивності та чутливості до жертв."
        },
        {
          "name": "Знецінення українських жертв",
          "context": "Тонке виправдання чи применшення страждань і втрат українських громадян в публічному дискурсі створює атмосферу знецінення жертв війни та маргіналізації їхньої пам’яті. Коли образ воєнного злочинця подається з позитивними відтінками — це нищить емпатію, підіграє інформаційним маніпуляціям і розмиває історичну справедливість. Таке знецінення підриває суспільний консенсус про необхідність вшанування загиблих і формується небезпечна тенденція до сприйняття насильства як буденного явища, замість того, щоб акцентувати увагу на гідності постраждалих та важливості збереження національної самоідентичності.",
          "solution": "Розбудувати національні й локальні ініціативи вшанування пам’яті жертв: створити освітні проєкти «Уроки пам’яті» за участю очевидців та істориків, які розкриватимуть реальні історії постраждалих; підтримати культурні заходи (виставки, концерти, літературні читання) із залученням міжнародних партнерів для підсилення гуманітарного дискурсу; впровадити в медіа регулярні рубрики з аналізом воєнних злочинів і свідченнями постраждалих, використовуючи фактчекінг та звернення до авторитетних джерел; заохочувати журналістів дотримуватися стандартів емоційного інтелекту і гуманітарного підходу, створивши етичні кодекси зобов’язань та систему громадського моніторингу; залучати молодь до волонтерських акцій із відновлення меморіалів та допомоги сім’ям загиблих, щоб зміцнити національну солідарність та зберегти історичну правду."
        },
        {
          "name": "Моральна апатія або необізнаність",
          "context": "Відсутність або недостатня обізнаність щодо контексту військових злочинів свідчить про моральну апатію, в якій спотворюються етичні стандарти та ослаблюється громадянська відповідальність. Небажання аналізувати факти й перевіряти інформацію призводить до поширення дезінформації і викривлення реальних подій, що знижує якість громадського діалогу та уможливлює маніпуляції. Умонастрої байдужості й ігнорування правди формують середовище, де суспільство втрачає здатність адекватно оцінювати жахливі наслідки війни та захищати інтереси постраждалих.",
          "solution": "Запустити національну кампанію «Не будь байдужим» із залученням лідерів думок, медіа та громадських організацій для підвищення рівня обізнаності про воєнні злочини й гуманітарні катастрофи; розробити інтерактивні онлайн-платформи й мобільні додатки з архівами свідчень та документів, що заохочують користувачів до фактчекінгу та критичної оцінки інформації; включити у шкільні та університетські програми курси з медіаосвіти, етичних норм та історії сучасних конфліктів, використовуючи кейс-стаді, групові проєкти й дебати; організувати тренінги для журналістів, викладачів і волонтерів із формування емоційної стійкості та навичок розпізнавання дезінформації; створити грантові програми для підтримки дослідницьких проєктів та ініціатив, що спрямовані на попередження моральної апатії, розвиток солідарності й активної громадянської позиції."
        }
      ]
    }
  },
  {
    "post": "bbc.ua — мерзенний смітник, навіть коли опрацьовує важливу тему. За посиланням на статтю жодного слова немає про дітей Де Ніро, які зробили гендерний перехід. Тобто редактора виришили, що особистість актора не достатньо цікава громадськості, треба ще клікбейту додати. В коментарях любителі вау-ефекта, яким взагалі до сраки, що там за посиланням.",
    "json": {
      "problems": [
        {
          "name": "Сенсаційність у ЗМІ",
          "context": "Сенсаційне подання інформації, засноване на шокових заголовках, клікбейті та емоційній експлуатації читача, пересуває журналістику з платформи точних фактів на поле маніпулятивних прийомів. Постійна гонитва за увагою аудиторії стимулює експлуатацію людських почуттів, знижує рівень довіри та сприяє поширенню дезінформації. Така сенсаційність підриває інформаційну гігієну, руйнує професійну етику медіа і позбавляє читачів можливості формувати критичне мислення, що особливо небезпечно в умовах інформаційної війни.",
          "solution": "Впровадити у медіа галузі зобов’язуючі етичні кодекси та стандарти, що забороняють використання клікбейту, маніпулятивних заголовків і спекуляцій на емоціях; створити незалежні органи медіа-нагляду та громадські ради за участю журналістів, правозахисників і науковців для моніторингу якості контенту та розслідування скарг аудиторії; організувати регулярні тренінги й семінари для редакторів і кореспондентів із журналістської етики, аналітики та фактчекінгу; підтримувати ініціативи з розвитку сертифікації медіаграмотності серед споживачів інформації через онлайн-курси, відеоуроки та публікації в соціальних мережах; стимулювати фінансово проєкти, що створюють якісний журналістський контент, шляхом грантів та партнерств із міжнародними фондами."
        },
        {
          "name": "Викривлення фактів",
          "context": "Викривлення фактів у журналістських матеріалах, яке проявляється через додавання непідтверджених деталей, недбалий фактчекінг або свідоме вилучення важливих даних, створює перекручену картину подій. Це порушує стандарти перевірки джерел і професійну етику, знижує довіру аудиторії й відкриває простір для маніпуляцій. Без належного балансування думок та аналітики такі статті посилюють упередження, формують дезінформаційні наративи і руйнують інформованість громадян.",
          "solution": "Посилити інституційні механізми фактчекінгу: створити централізовані незалежні лабораторії перевірки інформації з участю академічних установ, технологічних компаній і журналістських асоціацій; впровадити у редакціях обов’язкову процедуру подвійної перевірки критичних фактів й адаптувати нейронні мережі для раннього виявлення потенційної дезінформації; організувати навчальні програми для журналістів із методології fact-check та роботи з відкритими даними, використовуючи інструменти open data analytics; залучити громадськість до краудфандингових розслідувань та публічних звітів про маніпуляції в ЗМІ; запровадити міжнародну коаліцію медіа-організацій для обміну досвідом і кращими практиками протидії викривленню фактів."
        },
        {
          "name": "Знецінення приватного життя",
          "context": "Ігнорування норм журналістської етики щодо захисту особистої сфери призводить до знецінення приватного життя публічних осіб, порушуючи баланс між суспільним інтересом та правом на конфіденційність. Використання матеріалів про особисті справи без згоди або в клікбейтному контексті руйнує довіру і ставить під загрозу психологічну безпеку героїв матеріалів. Це порушує законодавчу базу про захист персональних даних і знижує авторитет медіа.",
          "solution": "Розробити та імплементувати законодавчі механізми та професійні стандарти, що гарантують захист персональних даних та приватного життя: адаптувати європейський GDPR до українського законодавства, вводячи жорсткі санкції за порушення конфіденційності; створити комісію з етики та прав людини для розгляду скарг на медіа за розкриття особистих даних без згоди; проводити регулярні курси для журналістів з юридичних аспектів конфіденційності, дотримання інформованої згоди та психологічної безпеки героїв матеріалів; заохочувати платформу публічних принципів журналістської етики з підписанням зобов’язань керівниками редакцій; підтримати громадські ініціативи з захисту прав публічних осіб та створити гарячі лінії адвокатської допомоги для постраждалих."
        },
        {
          "name": "Поверхневість аудиторії",
          "context": "Поверхневе сприйняття контенту аудиторією, яка обмежується заголовками і короткими тизерами, призводить до зниження критичного мислення та аналітичних навичок. Клікбейтні заголовки стимулюють імпульсивне споживання інформації без фактчекінгу, формуючи середовище для поширення чуток і стереотипів. Така пасивність глядачів підриває інформованість громадян, зменшує соціальну відповідальність і робить суспільство вразливим до медійних маніпуляцій.",
          "solution": "Оновити освітні програми в школах та університетах, включивши курси з медіаграмотності, аналізу джерел та розвитку критичного мислення: створити інтерактивні навчальні модулі з кейс-стаді на реальних прикладах маніпуляцій у ЗМІ; організувати клуби дебатів та публічних дискусій, де студенти вправлятимуться в аналізі текстів і визначенні клікбейтних елементів; запустити національну онлайн-платформу «Факт чи вигадка» з конкурсами та винагородами за правильну ідентифікацію достовірних джерел; залучити блогерів і лідерів думок до просвітницьких відео та подкастів про безпечне споживання контенту; підтримувати громадські ініціативи з проведення публічних лекцій і тренінгів для людей різного віку щодо медіаграмотності."
        }
      ]
    }
  },
  {
    "post": "Виховання йде від батьків дитини, але і вчителі повинні проводити бесіди, звертати увагу дітей на таку проблему. Що, ці „педагогині-богині” не бачили, що дітки цієї жінки дуже переживають?!! Бачили... Бо бездушні, та жорстокі, байдужі до дітей, яких, так би мовити, вчать.",
    "json": {
      "problems": [
        {
          "name": "Байдужість педагогів до дітей",
          "context": "Бездушне ставлення педагогів до емоційних потреб та індивідуальних особливостей учнів створює атмосферу байдужості, що порушує професійну етику та фундаментальні засади виховної взаємодії. Неврахування дитячих переживань і страхів знижує ефективність навчального процесу, призводить до демотивації та зниження самооцінки школярів, порушуючи їхнє право на безпечне психоемоційне середовище. Внаслідок такої професійної пасивності діти втрачають довіру до авторитетів, що блокує розвиток комунікативних навичок і перешкоджає формуванню відповідальної громадянської позиції.",
          "solution": "Підвищити кваліфікацію педагогів через обов’язкові тренінги з емоційного інтелекту, психосоціальної підтримки та кризової інтервенції, що включають інтерактивні вправи, рольові ігри та супервайзерські сесії; впровадити в школах постійний супровід психологів і соціальних педагогів для проведення індивідуальних та групових консультацій; створити внутрішні шкільні команди підтримки, де вчителі обмінюються досвідом і працюють над розробкою адаптивних методик спілкування з учнями; запровадити систему регулярного зворотного зв’язку від учнів та батьків щодо емоційного клімату в класі; стимулювати педагогів до участі в міжнародних обмінах та конференціях із психологічної підтримки дітей, щоб застосовувати світові практики емпатійного навчання."
        },
        {
          "name": "Невиконання виховної функції школи",
          "context": "Ігнорування педагогами виховної місії школи призводить до кризи соціалізації та нехтування формуванням моральних цінностей у підростаючого покоління. Коли навчальний заклад обмежується передачею знань без системної роботи над розвитком етичних норм, відповідальності та соціальної взаємодії, діти втрачають орієнтири у складних моральних дилемах. Відсутність налагодженої співпраці між учителями, батьками та психологами позбавляє учнів можливості отримати цілісний виховний супровід, необхідний для успішної інтеграції у суспільство.",
          "solution": "Розробити та впровадити комплексну стратегію виховання, що поєднує академічні дисципліни з етичними та соціальними модулями: інтегрувати в навчальну програму предмети «Громадянська освіта» та «Емоційний інтелект», використовуючи інтерактивні методики проектного навчання і кейс-стаді; налагодити партнерство між школою, батьківськими комітетами та психологічними службами для спільного планування виховних заходів, тренінгів і соціальних проєктів; створити менторські програми, де старші учні допомагають молодшим розв’язувати конфлікти та будувати зрілі міжособистісні стосунки; запровадити систему оцінювання виховного процесу через регулярні опитування учнів, батьків і педагогів; організувати тематичні фестивалі, форум-театри та дебати, які сприятимуть виробленню моральних норм і громадянської відповідальності."
        },
        {
          "name": "Психологічна травматизація дітей",
          "context": "Систематичні прояви жорстокості чи ігнорування емоційних потреб учнів учителями можуть спричинити глибоку психологічну травматизацію, залишаючи довготривалі негативні наслідки для психосоціального здоров’я дітей. Дитячі страхи, тривога та недовіра до дорослих накопичуються, формуючи низьку стресостійкість і порушуючи процеси пізнання. Відсутність оперативного втручання шкільної служби підтримки та базових елементів психологічної безпеки ускладнює відновлення дітей і знижує їхню здатність до навчання, міжособистісних стосунків і розвитку резилієнтності.",
          "solution": "Створити у кожному навчальному закладі мультидисциплінарну службу психологічної підтримки, до складу якої увійдуть практичні психологи, соціальні педагоги, логопеди та фахівці з арт-терапії; впровадити регулярні скринінги емоційного стану учнів із подальшою індивідуальною або груповою терапією через методи когнітивно-поведінкової та ігрової терапії; проводити для вчителів тренінги з розпізнавання ознак травматизації й кризових реакцій у дітей та алгоритми першої психологічної допомоги; розробити програми розвитку резилієнтності та стресостійкості через інтерактивні заняття, медіацію та заняття з майндфулнес; залучити волонтерів і громадські організації до організації літніх таборів й арт-проєктів, що сприяють одужанню та соціалізації постраждалих дітей."
        },
        {
          "name": "Критика системи освіти",
          "context": "Гостра критика системи освіти вказує на структурні дисфункції: застарілі стандарти, надлишкову бюрократію, нестачу інноваційних методик та недостатнє фінансування, що створює перепони для якісного навчального процесу. Докоряючи школам за брак глибокої виховної роботи, слід враховувати потребу в оновленні освітньої програми, підвищенні педагогічної автономії та залученні сучасних ресурсів. Без синергії між реформаторами, вчителями та батьками школи не зможуть реалізувати своє завдання з формування компетентностей і ціннісних орієнтирів майбутніх поколінь.",
          "solution": "Запровадити всеохоплючу освітню реформу, що передбачає децентралізацію управління школами та розширення педагогічної автономії для впровадження інноваційних методик навчання; переглянути стандарти освіти з метою інтеграції проєктно-орієнтованого підходу, STEM-навчання та креативних дисциплін; збільшити фінансування на професійний розвиток учителів, матеріально-технічну базу та цифрові ресурси через державно-приватні партнерства; створити робочі групи за участю представників Міністерства освіти, педагогів, батьків і студентів для підготовки та апробації пілотних програм та методичних рекомендацій; впровадити прозору систему оцінювання ефективності шкіл та педагогів з урахуванням показниківування розвитку м’яких навичок учнів, рівня їхнього емоційного благополуччя та здатності до критичного мислення."
        }
      ]
    }
  }
]

SCHEMA_HINT = '''
У відповіді "context" та "solution" повинні містити не менше 0 символів. Відповідь має бути лише валідним JSON-об’єктом такої форми:
{
  "problems": [
    { "name": "<рядок>", "context": "<рядок>", "solution": "<рядок>" },
    …
  ]
}
'''


def call_llm(prompt: str) -> str:
    """
    Uses LangChain’s ChatOpenAI to send a single system‐message prompt.
    Retries up to MAX_RETRIES on errors, with a short delay.
    """
    llm = ChatOpenAI(model_name=MODEL_NAME, temperature=0.1)
    for attempt in range(MAX_RETRIES + 1):
        try:
            response: AIMessage = llm([SystemMessage(content=prompt)])
            txt = response.content.strip()
            if txt.startswith("```json"):
                txt = txt.split("```json", 1)[1]
            if txt.endswith("```"):
                txt = txt.rsplit("```", 1)[0]
            return txt.strip()
        except Exception as e:
            if attempt == MAX_RETRIES:
                raise RuntimeError(f"LLM failed after {MAX_RETRIES} retries: {e}")
            time.sleep(REQUEST_DELAY_SECONDS)


def robust_json_load(raw: str, schema_hint: str) -> dict:
    """
    Attempts to parse `raw` as JSON. On failure, asks the LLM (via call_llm) to repair
    the JSON to fit SCHEMA_HINT, retrying up to MAX_RETRIES.
    """
    for attempt in range(MAX_RETRIES + 1):
        try:
            txt = raw.strip()
            if txt.startswith("```json"):
                txt = txt.split("```json", 1)[1]
            if txt.endswith("```"):
                txt = txt.rsplit("```", 1)[0]
            return json.loads(txt)
        except json.JSONDecodeError as e:
            if attempt == MAX_RETRIES:
                raise RuntimeError(f"JSON parse failed after {MAX_RETRIES} retries: {e}")
            repair_prompt = (
                f"Попередня відповідь невалидний JSON ({e}).\n"
                f"JSON був:\n```json\n{raw}\n```\n"
                f"Надайте тільки валідний JSON за схемою:\n{schema_hint}"
            )
            raw = call_llm(repair_prompt)


def detect_problems_and_solutions_llm(message: str) -> List[Dict[str, str]]:
    """
    Builds a few‐shot prompt (with EXAMPLES & SCHEMA_HINT), sends it to gpt‐4 via LangChain,
    and returns a list of {"name", "context", "solution"} dicts.
    """
    llm = ChatOpenAI(model_name=MODEL_NAME, temperature=0.0)
    messages = [
        SystemMessage(content=(
            "Ти — експерт з аналізу дописів в соціальних мережах українською мовою. "
            "Витягни глибинні соціальні чи психологічні проблеми, які висловлює автор, та запропонуй рішення для кожної проблеми."
        ))
    ]

    # Insert example pairs
    for ex in EXAMPLES:
        messages.append(HumanMessage(content=f"Пост:\n{ex['post']}"))
        messages.append(AIMessage(content=json.dumps(ex["json"], ensure_ascii=False)))

    # Finally, the actual user post + schema hint
    messages.append(HumanMessage(content=f"Пост:\n{message}\n\n{SCHEMA_HINT}"))

    for attempt in range(MAX_RETRIES + 1):
        try:
            response: AIMessage = llm(messages)
            out = robust_json_load(response.content, SCHEMA_HINT)
            return out.get("problems", [])
        except Exception as e:
            if attempt == MAX_RETRIES:
                raise RuntimeError(f"LLM detection failed after {MAX_RETRIES} retries: {e}")
            time.sleep(REQUEST_DELAY_SECONDS)


def detect_problems(db_file: str, message_id: int) -> List[int]:
    """
    1) Fetch the message text by message_id from `messages`.
    2) Run detect_problems_and_solutions_llm(...) to get a list of {"name", "context", "solution"}.
    3) Upsert each problem into `problems(...)`.
    4) Return a list of all problem_id values inserted/updated.
    """
    openai_key = os.getenv("OPENAI_API_KEY")
    if not openai_key:
        raise RuntimeError("OPENAI_API_KEY not set")

    with Database(db_file) as db:
        # 1) Fetch original message text
        text = db.get_message_by_id(message_id)
        if not text:
            raise ValueError(f"Message ID {message_id} not found in DB")

        # 2) Call LLM → list of problem dicts
        problems = detect_problems_and_solutions_llm(text)

        # 3) Upsert into `problems` and collect problem_ids
        problem_ids = []
        for p in problems:
            pid = db.upsert_problem(p["name"], p["context"])
            problem_ids.append(pid)

        return problem_ids
